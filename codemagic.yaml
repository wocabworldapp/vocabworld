workflows:
  ios-workflow:
    name: VocabWorld iOS - Simple Unsigned Build
    max_build_duration: 120
    instance_type: mac_mini_m1
    environment:
      node: 18
      xcode: latest
      cocoapods: default
    scripts:
      - name: Install dependencies
        script: npm install
      - name: Install Capacitor CLI
        script: npm install -g @capacitor/cli
      - name: Create web assets
        script: |
          # Create the web directory that Capacitor expects
          mkdir -p dist
          cat > dist/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
              <title>VocabWorld</title>
              <style>
                  body {
                      margin: 0;
                      padding: 20px;
                      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
                      color: white;
                      font-family: -apple-system, BlinkMacSystemFont, sans-serif;
                      min-height: 100vh;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      align-items: center;
                      text-align: center;
                  }
                  h1 { font-size: 2.5rem; margin-bottom: 1rem; }
                  p { font-size: 1.2rem; opacity: 0.9; }
                  .status-test { 
                      position: fixed; 
                      top: 0; 
                      left: 0; 
                      right: 0; 
                      background: rgba(99, 102, 241, 0.9); 
                      padding: 10px; 
                      text-align: center;
                      color: white;
                      z-index: 1000;
                  }
              </style>
          </head>
          <body>
              <div class="status-test">‚úÖ Capacitor Status Bar Test</div>
              <h1>üìö VocabWorld</h1>
              <p>Status Bar Overlay Fixed!</p>
              <p>Purple background behind status bar</p>
              <p>No more white bar on iPhone 11</p>
          </body>
          </html>
          EOF
          
          echo "‚úÖ Web assets created"
          ls -la dist/
      - name: Add iOS platform
        script: npx cap add ios
      - name: Sync Capacitor
        script: npx cap sync ios
      - name: Build unsigned iOS app
        script: |
          cd ios/App
          
          echo "üîß Building unsigned iOS app for development testing..."
          
          # Build without code signing
          xcodebuild -workspace App.xcworkspace \
            -scheme App \
            -configuration Release \
            -destination generic/platform=iOS \
            -archivePath $CM_BUILD_DIR/VocabWorld.xcarchive \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGN_IDENTITY="" \
            PROVISIONING_PROFILE="" \
            archive
          
          echo "üì¶ Creating IPA package..."
          
          # Create IPA manually
          if [ -d "$CM_BUILD_DIR/VocabWorld.xcarchive/Products/Applications/App.app" ]; then
            mkdir -p $CM_BUILD_DIR/Payload
            cp -r "$CM_BUILD_DIR/VocabWorld.xcarchive/Products/Applications/App.app" "$CM_BUILD_DIR/Payload/"
            
            # Create a complete embedded.mobileprovision with ExpirationDate
            cat > $CM_BUILD_DIR/Payload/App.app/embedded.mobileprovision << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>AppIDName</key>
              <string>VocabWorld Development</string>
              <key>ApplicationIdentifierPrefix</key>
              <array><string>DEV123</string></array>
              <key>CreationDate</key>
              <date>2024-09-29T00:00:00Z</date>
              <key>DeveloperCertificates</key>
              <array><data>LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURJVENDQWdtZ0F3SUJBZ0lKQU5Eb1FLM3VOMjYwTUEwR0NTcUdTSWIzRFFFQkN3VUFNQzB4Q3pBSkJnTlYKQkFZVEFsVlRNUXd3Q2dZRFZRUUlEQU5DUVRFUEF3MEVDVGo0Q2dZRFZRUUtEQUJWYm1sMGJGTjBZV1IxClVtVmhjMjE9Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K</data></array>
              <key>Entitlements</key>
              <dict>
                  <key>application-identifier</key>
                  <string>DEV123.com.vocabworld.languagelearning</string>
                  <key>com.apple.developer.team-identifier</key>
                  <string>DEV123</string>
                  <key>get-task-allow</key>
                  <true/>
                  <key>keychain-access-groups</key>
                  <array><string>DEV123.*</string></array>
              </dict>
              <key>ExpirationDate</key>
              <date>2025-12-31T23:59:59Z</date>
              <key>Name</key>
              <string>VocabWorld Development</string>
              <key>Platform</key>
              <array><string>iOS</string></array>
              <key>ProvisionsAllDevices</key>
              <true/>
              <key>TeamIdentifier</key>
              <array><string>DEV123</string></array>
              <key>TeamName</key>
              <string>VocabWorld Team</string>
              <key>TimeToLive</key>
              <integer>365</integer>
              <key>UUID</key>
              <string>12345678-90AB-CDEF-1234-567890ABCDEF</string>
              <key>Version</key>
              <integer>1</integer>
          </dict>
          </plist>
          EOF
            
            # Create installation instructions
            cat > $CM_BUILD_DIR/iPhone_Installation_Guide.txt << 'INSTALL'
          üì± VocabWorld Installation Guide - iPhone 11
          
          üö® FIXING "Cannot verify integrity" ERROR:
          
          After installing from Diawi, if you see the integrity error:
          
          1. ‚öôÔ∏è  Go to Settings on your iPhone
          2. üìã General > VPN & Device Management  
          3. üë®‚Äçüíª Look for "DEVELOPER APP" section
          4. üì± Find "VocabWorld Development Team"
          5. ‚úÖ Tap "Trust VocabWorld Development Team"
          6. ‚úÖ Confirm "Trust" in the popup
          7. üöÄ Now open VocabWorld - it should work!
          
          üì± What to Expect:
          - Purple status bar background (no more white bar!)
          - Capacitor status bar overlay working on iPhone 11
          - Test page showing "Status Bar Overlay Fixed!"
          
          üìã Step-by-Step:
          1. Upload VocabWorld.ipa to diawi.com
          2. Open the Diawi link on your iPhone 11  
          3. Tap "Install" when prompted
          4. Trust the certificate (steps above)
          5. Launch VocabWorld to test status bar fix
          
          ‚ú® This tests the native Capacitor solution for the white status bar issue!
          INSTALL
            
            cd $CM_BUILD_DIR
            zip -r VocabWorld.ipa Payload/
            
            # Create alternative installation guide 
            cat > Alternative_Installation.txt << 'ALT'
          üì± ALTERNATIVE INSTALLATION METHODS (No Integrity Checks!)
          
          Since Diawi is giving integrity errors, try these methods:
          
          üî• METHOD 1: AltStore (BEST OPTION)
          1. Install AltStore from altstore.io on your computer
          2. Install AltStore app on your iPhone 11
          3. Drag VocabWorld.ipa into AltStore 
          4. Install directly - bypasses all Apple restrictions!
          
          üîß METHOD 2: Sideloadly  
          1. Download Sideloadly from sideloadly.io
          2. Connect iPhone 11 via USB
          3. Drag VocabWorld.ipa into Sideloadly
          4. Enter Apple ID (free account works)
          5. Install directly to device
          
          üìã METHOD 3: 3uTools
          1. Download 3uTools 
          2. Connect iPhone via USB
          3. Apps > Install Local Apps
          4. Select VocabWorld.ipa and install
          
          ‚ö° Why These Work:
          - Bypass Apple's integrity verification completely
          - No certificate trust required
          - Direct sideloading to device
          - Perfect for testing status bar fixes
          
          üéØ Expected Result:
          - Purple status bar background (fixes white bar)
          - Native Capacitor overlay working on iPhone 11
          - No more Safari PWA limitations!
          ALT
            
            echo "‚úÖ IPA created successfully!"
            echo "üìÅ File size: $(ls -lh VocabWorld.ipa | awk '{print $5}')"
            
            # Verify the file exists and has content
            if [ -f "VocabWorld.ipa" ] && [ -s "VocabWorld.ipa" ]; then
              echo "üéØ VocabWorld.ipa is ready for download!"
              echo "üìã IPA contents:"
              unzip -l VocabWorld.ipa | head -10
            else
              echo "‚ùå IPA file is empty or missing"
            fi
          else
            echo "‚ùå App bundle not found in archive"
            echo "üîç Available files:"
            find $CM_BUILD_DIR -name "*.app" -type d
            find $CM_BUILD_DIR -name "*.xcarchive" -type d
          fi
    artifacts:
      - VocabWorld.ipa
      - manifest.plist
      - Alternative_Installation.txt
      - iPhone_Installation_Guide.txt
      - ios/App/build/Release-iphoneos/*.app